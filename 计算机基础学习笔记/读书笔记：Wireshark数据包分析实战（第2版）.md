---
title: 读书笔记：Wireshark数据包分析实战（第2版）
date: 2019-12-25 22:44:38
tags: 读书笔记
categories: 工具学习
---

（注1：补充了一些看视频所做的笔记）

（注2：这个第3版电子书是真的难找，现在找的只是断章，剩下的都要钱，继续找一下了）

（注3：第3版我死活找不到，找了半天找了个英文版的，算了，把标题内容改成第二版吧，好像和第三版没有太大的改动）

# 第1章：数据包分析技术与网络基础

在计算机网络中，每天都可能发生成千上万、各式各样的问题，从简单的间谍软件感染，到复杂的路由器配置错误，不一而定。我们永远也不可能立即解决所有问题，而只能期盼充分地准备好相关的知识和工具，从而能够快速地响应各种类型的错误。

为了真正地理解网络问题，我们需要进入数据包层次。所有的网络问题都源于数据包层次，即使是最漂亮的应用程序，它们也可能是“金玉其外”但“败絮其中”，有着混乱的设计与糟糕的实现；又或是看起来是可信的，但背地里在搞些恶意的行为。现在，没有任何东西能够逃出我们的视线范围——这里不再有那些令人误解的菜单栏、用来吸引眼球的动画，以及无法让人信赖的员工。在数据包层次上，就不再有真正的秘密（加密通信除外），在数据包层次上做得越多，那我们就能够对网络有更好的控制，就能够更好、更快地解决网络问题。这就是数据包分析的世界。

## 数据包分析与数据包嗅探器

数据包分析，通常也被称为**数据包嗅探或协议分析**，指的是捕获和解析网络上在线传输数据的过程，通常是为了能更好地了解在网络上正在发生的事情。数据包分析过程通常由数据包嗅探器来执行，而数据包嗅探器则是一种用来在网络媒介上捕获原始传输数据的工具。

数据包分析技术可以用来达到如下目标。

* 了解网络特征。
* 查看网络上的通信主体。
* 确认谁或是哪些应用在占用网络带宽。
* 识别网络使用高峰时间。
* 识别可能的攻击或恶意活动。
* 寻找不安全以及滥用网络资源的应用。

目前市面上有着多种类型的数据包嗅探器，包括免费的和商业的。每个软件的设计目标都会存在一些差异。流行的数据包分析软件包括Tcpdump、OmniPeek和Wireshark（我们在这本书中只使用此款软件）。Tcpdump是一个命令行程序，而Wireshark和OmniPeekd都拥有图形用户界面（GUI）。

### 评估数据包嗅探器

当你选择一款数据包嗅探器时，考虑的因素很多，包括以下几点。

支持的协议：数据包嗅探器对协议解析的支持范围是各不相同的，大部分通常都能解析常见的网络协议（如IPv4和ICMP）、传输层协议（如TCP和UDP），甚至一些应用层协议（如DNS和HTTP）。然而，它们可能并不支持一些非传统的或新的协议（如IPv6、SMBV2、SIP等）。在选择一款嗅探器时，需要确保它能够支持你所要用到的协议。

用户友好性：考虑数据包嗅探器的界面布局、安装的容易度，以及操作流程的通用性。你选择的嗅探器应该适合你的专业知识水平。如果你的数据包分析经验还很少的话，可能需要避免选择那些更高级命令行嗅探器，比如Tcpdump；另一方面，如果你拥有丰富的经验，你可能会觉得这类命令行程序更具有吸引力。在逐步积累数据包分析经验时，你甚至会发现组合使用多种数据包嗅探器软件将更有助于适应不同的应用场景。

### 数据包嗅探器工作过程

数据包嗅探过程中涉及软件和硬件之间的协作。这个过程可以分为成3个步骤。

第一步：收集，数据包嗅探器从网络线缆上收集原始二进制数据。
通常情况下，通过将选定的网卡设置成混杂模式来完成抓包。在这种模式下，网卡将抓取一个网段上的所有网络通信流量，而不仅是发往它的数据包。

第二步：转换，将捕获的二进制数据转换成可读形式。高级的命令行数据包嗅探器就支持到这一步骤。到这一步，网络上的数据包将以一种非常基础的解析方式进行显示，而将大部分的分析工作留给最终用户。

第三步（最后一步）：分析，对捕获和转换后的数据进行真正的深入分析。数据包嗅探器以捕获的网络数据作为输入，识别并验证它们的协议，然后开始分析每个协议的特定属性。

## 网络通信原理

为了充分理解数据包分析技术，你必须准确掌握计算机是如何通过网络进行相互通信的。在本节中，我们将研究网络协议、开放系统互连模型（OSI模型）、网络数据帧的基础知识，以及支持网络通信的硬件知识。

### 协议

现代网络是由多种运行在不同平台上的异构系统所组成的。为了帮助它们之间相互通信，我们使用了一套共同的网络语言，并称之为协议。常见的网络协议包括传输控制协议（TCP）、互联网协议（IP）、地址解析协议（ARP）和动态主机配置协议（DHCP）。协议栈是由一组协同工作网络协议的逻辑组合而成的。

理解网络协议的最佳途径之一是将它们想象成人类口头或书面语言的使用规则。每一种语言都有规则，如动词应该如何结合、人们该如何问候，甚至该如何礼貌地致谢。网络协议大多也是以同样方式进行工作的，帮助我们定义如何路由数据包、如何发起一个连接，以及如何确认收到的数据。一个网络协议可能非常简单，也可能非常复杂，这取决于它的功能。虽然各种协议往往有着巨大的差异，但它们通常用来解决以下问题。

发起连接：是由客户端还是服务器发起连接？在真正通信之前必须要交换哪些信息？

协商连接参数：通信需要进行协议加密吗？加密密钥如何在通信双方进行传输？

数据格式：通信数据在数据包中如何排列？数据在接收设备时以什么样的顺序进行处理？

错误检测与校正：当数据包花费过长的时间才到达目的地时该如何处理？当客户端暂时无法和服务器建立通信时，该如何恢复连接？

连接终止：一台主机如何告知另一台主机通信已经结束？为了礼貌地终止通信，应该传送什么样的最终信息？

### 七层OSI参考模型

网络协议是基于它们在行业标准OSI参考模型中的职能进行分层的。OSI模型将网络通信过程分为七个不同层次，如图1-1所示。这个分层模型使得我们更容易理解网络通信。

![](读书笔记：Wireshark数据包分析实战(第2版)/01.png)

顶端的应用层表示用来访问网络资源的实际程序。底层则是物理层，通过它来进行实际的网络数据传播。每一层次上的网络协议共同合作，来确保通信数据在协议上层或下层中得到妥善处理。

> OSI参考模型最初在1983年由国际标准化组织出版，标准号为ISO7498。OSI参考模型只是一个行业建议标准，协议开发时并不需要严格地遵守它。OSI参考模型也并不是现有唯一的网络模型，例如，有些人更推崇美国国防部（DoD）的网络模型，也被称为TCP/IP模型。

![](读书笔记：Wireshark数据包分析实战(第2版)/02.jpg)

应用层（Application layer，第7层）：OSI参考模型的最上层，为用户访问网络资源提供一种手段。这通常是唯一一层能够由最终用户看到的协议，因为它提供的接口，是最终用户所有网络活动的基础。

表示层（Presentation layer，第6层）：这一层将接收到的数据转换成应用层可以读取的格式。在表示层完成的数据编码与解码取决于发送与接收数据的应用层协议。表示层同时进行用来保护数据的加密与解密等操作。

会话层（Session layer，第5层）：这一层管理两台计算机之间的对话（会话），负责在所有通信设备之间建立、管理和终止会话连接。会话层还负责以全双工或者半双工的方式来创建会话连接，在通信主机间关闭连接，而不是粗暴地直接丢弃。

传输层（Transport layer，第4层）：传输层的主要目的是为较低层提供可靠的数据传输服务。通过流量控制、分段/重组、差错控制等机制，传输层确保网络数据端到端的无差错传输。因为要确保可靠的数据传输其过程极为烦琐，所以OSI参考模型将其作为完整的一层。传输层同时提供了面向连接和无连接的网络协议。某些防火墙和代理服务器也在这一层工作。

网络层（Network layer，第3层）：这一层负责数据在物理网络中的路由转发，是最复杂的OSI层之一。它除了负责网络主机的逻辑寻址（例如通过一个IP地址），还处理数据包分片和一些情况下的错误检测。路由器在这一层上工作。

数据链路层（Data link layer，第2层）：这一层提供了通过物理网络传输数据的方法，其主要目的是提供一个寻址方案，可用于确定物理设备（例如MAC地址）。网桥和交换机是工作在数据链路层的物理设备。

物理层（Physical layer，第1层）：OSI参考模型的底层是传输网络数据的物理媒介。这一层定义了所有使用的网络硬件设备的物理和电气特性，包括电压、集线器、网络适配器、中继器和线缆规范等。

物理层建立和终止连接，并提供一种共享通信资源的方法，将数字信号转换成模拟信号传输，并反过来将接收模拟信号转换回数字信号。

> 一个把OSI模型各个层次都记住的口诀是Please Do Not Throw Sausage Pizza Away。从第一层开始，每个单词的首字母依次代表着OSI模型中的每一层。

表1-1列出了OSI参考模型各个层次上的一些常见网络协议。

![](读书笔记：Wireshark数据包分析实战(第2版)/03.png)

尽管OSI参考模型仅仅是一个建议标准，你还是应该将其牢记在心。阅读这本书时，你会发现，对不同层网络协议进行交互才能解决你所面对的网络问题。比如遇到路由器问题，你应该快速确认这是“第3层上的问题”，而应用软件问题则被识别为“第7层上的问题”。

> 在讨论我们的工作时，一位同事说他曾处理过一位用户的投诉，用户反映不能访问网络资源，而实际原因是用户输入的密码不正确。我的同事将这个案例标成了“第8层的问题”，第8层是对用户层的一种非官方说法，通常是由那些整天工作在数据包层次上的网络工程师们所使用。

### OSI参考模型中的数据流向

在网络上传输的初始数据首先从传输网络的应用层开始，沿着OSI参考模型的七层逐层向下，直到物理层。在这一层传输网络物理媒介会将数据发送到接收系统。接收系统从它的物理层获取到传输数据，然后向上逐层处理，直到最高的应用层。

OSI模型中的每层都只能直接与它的上层或下层协议通信。比如第二层只能从第一层和第三层中发送或接收数据。

在OSI模型任意层上，由不同协议提供的服务都不是多余的。例如，如果某层上的一个网络协议提供了一种服务，那么其他任何层上的协议都不会提供与之完全相同的服务。在不同层次的协议可能有类似目标的功能，但它们会是以不同的方式来实现。

在对应层次上，发送和接收的网络协议是相互配合的。比如，发送系统在第7层的某个协议负责对传输数据进行编码封装，那么往往在接收系统的第7层有着相应的网络协议，负责对网络数据进行解码读取。

图1-2中连接了两个通信端，对OSI参考模型进行了图形化的说明。你可以看到通信数据会从一个通信端的顶部流向底部，然后当它到达另一通信端时，将反向从底部流向顶部。

![](读书笔记：Wireshark数据包分析实战(第2版)/04.png)

### 数据封装

OSI参考模型不同层次上的协议在数据封装的帮助下进行通信传输。协议栈中的每层协议都负责在传输数据上增加一个协议头部或尾部，其中包含了使协议栈之间能够进行通信的额外信息。例如，当传输层从会话层接收数据时，它会在将数据传递到下一层之前，附上自己的头部信息数据。

数据封装过程将创建一个协议数据单元（PDU），其中包括正在发送的网络数据，以及所有增加的头部与尾部协议信息。随着网络数据沿着OSI参考模型向下流动，PDU逐渐变化、增长，各层协议均将其头部或尾部信息添加进去，直到物理层时达到其最终形式，并发送给目标计算机。接收计算机收到PDU后，沿着OSI参考模型往上处理时，逐层剥去协议头部和尾部，当PDU到达OSI参考模型的最上层时，将只剩下原始传输数据。

> OSI参考模型使用特别的术语来描述每一层的数据。物理层叫比特，数据链路层叫帧，网络层叫数据包，传输层叫数据段。最上面的三层可以统称数据，但这些叫法实际上用得并不多，我们一般会使用报文来表示一个完整或部分PDU，该PDU从多个OSI参考层中包含了表头和表尾信息。

让我们通过一个实际的例子来理解数据的封装过程，这个例子描述了数据包是如何在OSI参考模型中被创建、传输和接收的。作为数据包分析师，你需要了解，我们经常会忽略掉会话层和表示层，所以它们将不会在这个例子中出现（包括本书的其余部分）。

假设这样一个情形：我们试着在计算机上浏览Google。在这个过程中，我们必须首先产生一个请求数据包，从客户端计算机传输到目标服务器上。这里我们假设TCP/IP通信会话已经被建立，图1-3则展示了此案例中的数据封装处理过程。

![](读书笔记：Wireshark数据包分析实战(第2版)/05.png)

我们从客户端计算机的应用层开始，在我们浏览一个网站时，所使用的应用层协议是HTTP，通过此协议发出请求命令，从Google下载index.html文件。

> 在实践中，浏览器会向网站的根目录文件发出请求，通常使用正斜杠（/）来表示。当Web服务器接收到该请求时，它会根据服务器的网页根目录设定对浏览器重定向。根目录文件名通常是index.html或index.php。我们会在第9章讨论更多有关HTTP的内容。

应用层协议发送出指令后，我们就开始关心数据包是如何被发送到目的地的。数据包中的应用层数据将沿着OSI参考模型的协议栈传递给传输层。HTTP是一个使用TCP（或在TCP协议之上）的应用层协议，因此传输层将使用TCP协议来确保数据包的可靠投递。一个包括序列号和其他数据的TCP协议头部将被创建，并添加到PDU中，如图1-3所示。该TCP表头包含了序列号和其他信息，以确保数据包能够被正确交付。

> 我们常说一个协议在其他协议之上，是因为0SI参考模型的分层设计。例如HTTP等应用层协议提供了一个特定的服务，并依靠TCP协议来保证服务的可靠交付。正如你学习到的，DNS协议架构于UDP之上，而TCP架构在IP之上。

在完成这项工作之后，TCP协议将数据包交给IP协议，也就是在第3层上负责为数据包进行逻辑寻址的协议。IP协议创建一个包含有逻辑寻址信息的头部，并将数据包传递给数据链路层上的以太网协议，然后以太网物理地址会被添加并存储在以太网帧头中。现在数据包已经完全组装好并传递给物理层，在这里数据包通过0、1信号完成通过网络的传输。

封装好的数据包将穿越网络线缆，最终到达Google的Web服务器。
Web服务器开始从下往上读取数据包，这意味着它首先读取数据链路层，从中提取到所包含的物理以太网寻址信息，确定数据包是否是发往这台服务器的。一旦处理完这些信息，第2层头部与尾部的信息将被剥除，并进入到第3层的信息处理过程中。

第3层IP寻址信息会被读取，以便确认数据包被正确转发，以及数据包并未进行分片处理。这些信息也同样被剥除，并交到下一层进行处理。

第4层TCP协议信息现在被读取，以确保数据包是按序到达的。然后第4层报头信息被剥离，留下的只有应用层数据。这些数据会被传递到Web服务器应用程序。为了响应客户端发过来的这个数据包，服务器应该发回一个TCP确认数据包，使客户端知道它的请求已经被接收，并可以等待获取index.html文件内容了。

所有数据包都会以这个例子中描述的过程进行创建和处理，而无论使用的是哪种协议。

但同时，请牢记并非每个网络数据包都是从应用层协议产生的，所以你会进一步看到只包含第2层、第3层或第4层协议信息的数据包。

### 网络硬件

现在是时候来看一看网络硬件了，至此脏活累活都已经完成，接下来的内容都很简单了。我们将专注于几个较为常见的网络硬件：集线器、交换机和路由器

1. 集线器

   集线器一般是提供了多个RJ-45端口的机盒，图1-4所示为一个NETGEAR集线器。集线器从非常小的4端口的设备，到企业环境中安装机架设计的48端口机盒设备，变化很大。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/06.png)

   因为集线器产生很多不必要的网络流量，并仅在半双工模式下运行（不能在同一时间发送和接收数据），所以你通常不会在现代或高密度的网络中再看到它们的身影了（用交换机来代替）。然而，你应该知道集线器的工作机制，因为它们对于数据包分析技术非常重要，特别是在实施我们将于第2章介绍的“枢纽”技术时。

   一个集线器无非就是工作在OSI参考模型物理层上的**转发设备**。它从一个端口接收到数据包，然后将数据包传输（中继）到设备的每个端口上。例如，如果一台计算机连接到一个4端口集线器的1号端口上，需要发送数据到连接在2号端口的计算机，那么集线器将会把数据发送给端口2、3、4。连接到3号端口与4号端口上的客户端计算机通过检查以太网帧头字段中的目标媒体访问控制（MAC）地址，判断出这些数据包并不是给它们的，便丢弃这些数据包。

   图1-5是一个从计算机A发送数据到计算机B的例子，当计算机A发送出数据时，所有连接到集线器的计算机都将接收到数据，但只有计算机B会实际将数据接收下来，而其他计算机则将丢弃它。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/07.png)

   作一个比喻，假设你发送一封主题为“所有的营销人员请注意”的电子邮件给贵公司所有雇员，而不是只有那些在营销部门工作的人。市场营销部门的员工会知道这封邮件是给他们的，他们很可能会打开它；而其他员工看到这封邮件并不是给他们的，则很可能会选择丢弃。可以看出这会导致很多不必要的通信和时间浪费，然而这正是集线器的工作原理。在高密度的实际网络中，集线器最好的替代产品是交换机，它们是支持全双工的设备，可以同步地发送和接收数据。

2. 交换机

   与集线器相同，交换机也是用来转发数据包的。但与集线器不同的是，交换机并不是将数据广播到每一个端口，而是将数据发送到目的计算机所连接的端口上。如同你在如图1-6中看到的那样，交换机的外表与集线器十分相似。

   市场上几个大牌公司的交换机，比如思科品牌的交换机，能够通过专业化的供应商特定软件或Web接口进行远程管理。这些交换机通常被称为管理型交换机。管理型交换机提供了多种在网络管理中非常有用的功能特性，包括启用或禁用特定端口、查看端口细节参数、远程修改配置、远程重启等。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/08.png)

   交换机在处理传输数据包时，经常会提供一些先进的功能。为了能够直接与一些特定设备进行通信，交换机必须能够通过MAC地址来唯一标识设备，这意味着它们必须工作在OSI参考模型的**数据链路层**上。

   交换机将每个连接设备的2层地址都存储在一个CAM（Content Addressable Memory：内容寻址寄存器）表中，CAM表充当着一种类似交通警察的角色。当一个数据包被传输时，交换机读取数据包中的第2层协议头部信息，并使用CAM表作为参考，决定往哪个或哪些端口发送数据包。交换机仅仅将数据包发送到特定端口上，从而大大降低了网络流量。

   图1-7说明了流量经过交换机进行传输的过程。在这个图示中，计算机A发送数据到唯一的目标：计算机B，虽然同一时间里网络上可能有很多会话，但信息将会直接通过交换机和目标接收者进行传输，而不会被传递到交换机和所有连接计算机之间。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/09.png)

3. 路由器

   路由器是一种比交换机或集线器具有更高层次功能的先进网络设备。一个路由器可以有许多种不同的形状和外形，但大多数路由器在正前方的面板上会有几个LED指示灯，在背板上会有一些网络端口，个数则取决于网络的大小。图1-8显示了一款路由器的外形。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/10.png)

   路由器工作在OSI参考模型的第3层，它们负责在两个或多个网络之间转发数据包。路由器在网络间引导数据包的流向，这一过程被称为路由。几种不同类型的路由协议定义了不同目的的数据包如何被路由到其他网络。路由器通常使用第3层地址（如IP地址）来唯一标识网络上的设备。

   为了更清楚地解释路由的概念，我们以一个拥有几条街道的街区进行类比。
   假设有一些房子，它们都有着自己的地址，就像网络上的计算机一样，而每条街道就如同网段，如图1-9所示。从你所在街道上的某个房子，你可以很容易地与同一街道中居住的邻居进行沟通交流，这类似于交换机的操作，能够允许在同一网段中的所有计算机进行相互通信。

   然而，与其他街道上居住的邻居进行沟通交流，就像是与不同网段中的计算机进行通信。参照图1-0，假设你住在藤街503号，需要到山茱萸巷202号。如果想要过去，你必须先到橡树街，然后再到山茱萸巷。现在请对应到跨越网段的场景中，如果在192.168.0.3地址的设备需要和192.168.0.54地址的设备进行通信，它必须经由路由器到10.100.1.1网络上，然后再经过连接目的网段的路由器，才可以到达目标网段。

   网络上的路由器的数量与大小通常取决于网络的规模与功能。个人和家庭办公网络可能只需要一个放置在网络中心的小型路由器。而大型企业网络则可能有几个路由器分布在不同的部门，它们都连接到一个大型的中央路由器或三层交换机上（具有内置功能，可以充当一台路由器的先进型交换机）。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/11.png)

   当你开始查看越来越多的网络图时，就会更加了解网络数据流是如何流经这些不同类型的网络设备节点的，图1-10显示了路由网络中的一个很常见的布局形式。在这个例子中，两个单独的网络通过一个路由器进行连接。如果网络A上的计算机希望与网络B上计算机进行通信，则传输数据将必须通过路由器。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/12.png)

## 流量分类

网络流量可以分为3大类：广播、组播和单播。每个分类都具有不同的特点，决定着这一类的数据包该如何通过网络硬件进行处理。

### 广播流量

广播数据包会被发送到一个网段上的所有端口，而不管这些端口连接在集线器还是交换机上。但并非所有的广播流量都是通过相同方式构建的，而是包括第2层广播流量和第3层广播流量两种主要形式。例如，在第2层，MAC地址FF:FF:FF:FF:FF:FF是保留的广播地址，任何发送到这一地址的流量都将会被广播到整个网段。第3层也有着一些特定的广播地址。

在一个IP网络范围中最大的IP地址是被保留作为广播地址使用的。例如，在一个配置了192.168.0.XXX的IP范围，子网掩码是255.255.255.0的地址网络中，广播IP地址是192.168.0.255。

在通过多个集线器或交换机连接多种媒介的大型网络中，广播数据包将从一个交换机一直被中继到另一交换机上，从而传输到网络连接的所有网段上。广播数据包能够到达的区域被称为“广播域”，也就是任意计算机可以不用经由路由器即可和其他计算机进行直接传输的网段范围。图1-11显示了一个小型网络上存在两个广播域的例子。因为每个广播域会一直延伸到路由器，所以广播数据包只在它特定的广播域中流通。

![](读书笔记：Wireshark数据包分析实战(第2版)/13.png)

我们前面的类比也能很好地说明广播域是如何工作的。你可以将一个广播域想象成一条街道。如果你站在家门口叫喊，只有街道上的人才能够听到你的声音。而如果你想与不同街道上的人说话，那么你需要找到一种与他进行直接交流的方式，而不是在你的家门口大喊大叫（广播）。

### 组播流量

组播是一种将单一来源数据包同时传输给多个目标的通信方式。组播的目的是简化这个过程，并使用尽可能少的网络带宽。组播流量通过避免数据包的大量复制来达到优化效果，而对组播流量的处置方式则高度依赖于不同网络协议的实现细节。
实施组播的主要方法是通过一种将数据包接收者加入组播组的编址方案实现的，这也是IP组播的工作原理。这种编址方案确保数据包不会被传送到未预期的目的地。事实上IP协议将一整段的地址都用于组播，如果你在网络上看到224.0.0.0~239.255.255.255的IP地址，那么它很有可能就是组播流量。

### 单播流量

单播数据包会从一台计算机直接传输到另一台计算机。单播机制的具体实现方式取决于使用的协议。例如，一台设备希望与一个Web服务器进行通信，这便是一个端到端的连接，所以通信过程将由客户端设备发送数据包到这台Web服务器开始。这种类型的通信就是单播流量的典型例子。

# 第2章：监听网络线路

进行高效的数据包分析的一个关键决策是在哪里放置数据包嗅探器，以恰当地捕捉网络数据。数据包分析师通常把这个过程称为监听网络线路。简而言之，这是将数据包嗅探器安置在网络上恰当物理位置的过程。

然而遗憾的是，嗅探数据包并不像是将一台笔记本电脑连入网络中那么的简单。事实上，在有些时候，在网络布线系统上放置一个数据包嗅探器，要比实际分析数据包更难一些。

安置嗅探器的挑战是要考虑到种类繁多的用来连接网络的硬件设备。图2-1为一种典型的情况。由于网络上的3种主要设备（集线器、交换机、路由器）对网络流量的处理方式都不相同，因此你必须非常清楚你所分析的网络使用的是哪些硬件设备。

![](读书笔记：Wireshark数据包分析实战(第2版)/14.png)

本章的目标是帮助你理解如何在各种不同网络拓扑结构中安置数据包嗅探器。首先，让我们来看看，我们实际上是如何看到网络线路上所有传递的数据包的。

## 混杂模式

你需要一个支持混杂模式驱动的网卡，才可能在网络上嗅探数据包。混杂模式是什么样的模式呢？实际上它是一种允许网卡能够查看到所有流经网络线路数据包的驱动模式。

正如你在第1章了解到的那样，在网络上有一类广播流量，因此对于客户端来说，接收到并非以它们的地址作为目标的数据包是非常常见的。用来将给定IP地址解析成对应MAC地址的ARP协议，在任何网络上都是一个关键组感部分，且是一个很好的例子，能够说明有些网络流量并非是发送到指定的目标地址。为了找到对应的MAC地址，ARP协议会发出一个广播包并发送到广帮域中的每个设备，然后期望正确的客户端做出回应。

一个广播域（也就是一个网络段，其中任何一台计算机都可以无需经过路由器，直接传送数据到另一台计算机）是由几台电脑所组成的，但广播域中仅只有一个客户端应该对传输的ARP广播请求包感兴趣。一旦网络上的每台电脑都处理和回应ARP广播包，那网络的性能将变得非常的糟糕。

因此，其他网络设备上的网卡驱动会识别出这个数据包对于它们来说没任何用处，于是选择将数据包丢弃，而不是传递给CPU进行处理。将目标不点这台接收主机的数据包进行丢弃可以显著地提高网络处理性能，但这对数据分析师来说并不是个好消息。作为分析师，我们通常需要看到线路上传输的一个数据包，这样我们才不用担心会丢失掉任何关键的信息。

我们可以使用网卡的混杂模式来确保能够捕获所有的网络流量。一旦在混杂模式下工作，网卡将会把每一个它所看到的数据包都传递给主机的处理器，而无论数据包的目的地址是什么。一旦数据包到达CPU之后，它就可以被一个数据包嗅探软件捕获并进行分析。

现在的网卡一般都支持混杂模式，Wireshark软件包中也包含了libpcap/
WinPcap驱动，这让你能够很方便地在Wireshark软件界面上就将网卡直接切换到混杂模式上（我们将在第3章里介绍更多的libpcap/WinPcap的内容）。

为了能够学习本书中的数据包分析技术，你必须要有一个支持使用混杂模式的网卡与操作系统。只有在你只想看到发往你运行嗅探软件主机MAC地址的网络数据包的时候，你才不需要以混杂模式来进行嗅探。

> 在大多数操作系统（包括Windows）上，要想使用一个混杂模式的网卡，你就必须要提升用户权限到管理员级别。如果你不能在一个系统上合法地获得这些叔限，那你就不应该在这台系统上对所在网络进行任何方式的数据包嗅探。

## 在集线器连接的网络中进行嗅探

在使用集线器连接的网络中进行嗅探，对于任何数据包分析师来说，都是一个梦想。正如你在第1章中了解到的那样，流经集线器的所有网络数据包都会被发送到每一个集线器连接的端口。因此，要想分析一台连接到集线器上的电脑的网络通信，你所需要做的所有事情就是将数据包嗅探器连接到集线器的任意一个空闲端口上。你就能看到所有从那台电脑流入流出的网络通信，以及其他接入集线器的任意电脑之间的通信。

如图2-2所示，当你的嗅探器连接到一个集线器连接的网络后，你对本地网络的可视范围是不受限制的。

> 可视范围，这个术语将在整本书中很多图示中显示，表示你在数据包嗅探器中能够看到通信流量的主机范围。

令人遗憾的消息是，集线器网络已经是非常罕见的了，因为它们曾经给网络管理员们带来了很大的困扰，已经基本被海汰了。因为在集线器网络中，在任一时刻里，只有一个设备可以通信。因此，通过集线连接的设备必须与其他设备进行竞争，才能取得带宽进行通信，当两个或多个设备同时通信时，数据包就会产生冲突碰撞，如图2-3所示。结果可能是丢包，然后通信设备需要承担重新传输数据包带来的性能损失，而这又增加了网络拥塞和碰撞。当通信流量水平和碰撞概论增加之后，设备需要传输每个数据包3次甚至4次，这大大降低了网络性能。因此很容易理解为什么现在各种规模的网络都已经转而使用交换机了。

![](读书笔记：Wireshark数据包分析实战(第2版)/15.png)

##  在交换式网络中进行嗅探

正如第1章中所讨论的，交换机是在现在网络环境中最常见的连接设备类型。它们为通过广播、单播与多播方式传输数据提供了高效的方法。额外的，一些交换机还允许全双工通讯，也就是说，设备可以同时发送和接收数据。

而这对数据包分析师来说是不幸的，交换机给数据包嗅探带来了一些复杂因素。当你将嗅探器连接到交换机上的一个端口时，你将只能看到广播数据包，及由你自己电脑传输与接收的数据包，如图2-4所示。

在一个交换式网络中从一个目标设备捕获网络流量的基本方法有如下4种：**端口镜像、集线器接出（hubbing out）、使用网络分流器、ARP欺编攻击**。

![](读书笔记：Wireshark数据包分析实战(第2版)/16.png)

### 端口镜像

端口镜像，也许是在交换式网络中捕获一个目标设备所有的网络通信最简单的方法。为了使用端口镜像，你必须能够通过命令行或Web管理界面来访问目标设备所连接的交换机。此外，这个交换机还必须支持端口镜像的功能，以及有一个空闲的端口，让你可以插入你的嗅探器。

要启用端口镜像，你需要发出一个命令，来强制交换机将一个端口上的所有通信都镜像到另一端口上。例如，为了捕获交换机3号端口连接的设备发出的所有流量，你只需要简单地将你的嗅探分析器接入4号端口，然后将3号端口镜像复制到4号端口，这就可以让你看到你的目标设备传输与接收的所有网络流量。图2-5显示了端口镜像的原理。

![](读书笔记：Wireshark数据包分析实战(第2版)/17.png)

设置端口镜像的具体方法取决于不同的交换机制造商。对于大多数的交换机，你需要登录到命令行界面，然后输入端口镜像命令。你可以在表2-1中找到一些通用的端口镜像命令。

> 某些交换机提供基于Web的图形用户管理界面，并提供端口镜像作为一个选项，但这种配置方式不像命令行那么普遍和标准。但是，如果你的交换机提供了一种通过图形化界面可以高效配置端口镜像的方法，那么你也可以使用。

在进行端口镜像时，需要留意你所镜像端口的流量负载。有些交换机厂商允许你将多个端口的流量镜像到一个单独端口上，这在分析一个交换机上两个或多个设备的网络通信时可能是非常有用的。

然而，我们使用一些简单的算术来考虑会发生什么事情。比如你有一个24端口交换机，你将23个全双工的10Mbivs端口流量都镜像到一个端口上，M2你可能在这个端口上就会有460Mbit/s的流量。这将会远远超出一个单独端口的物理承受能力，因此在网络流量达到一定数量级后，将可能会导致数据包丢失，甚至网络速度变慢。

在这种情况下，交换机会丢弃所有多余的数据包，甚至“暂停”它们内部交换电路，从而造成通信中断。当你开始执行你的数据包捕获时，请务必小心不要让这种情况在你的网络中发生。

### 集线器输出

另一种在交换式网络中捕获目标设备通信流量的方式是集线器输出。使用这种技巧，你需要将目标设备和分析系统分段到同一网络段中，然后把它们直接插入到一个集线器上。

许多人认为集线器输出根本就是一种作弊方法，但是它在你不能进行端口镜像但仍对目标设备接入的交换机有着物理访问的时候，真的是一个完美的解决方案。为了进行集线器输出，你所需要的就是一个集线器和几根网线。当你找齐了硬件之后，就可以按照如下操作步骤进行连接。

1. 找到目标设备所连接的交换机，并将目标设备连接网线从交换机上拔掉。
2. 将目标设备的网线插入到你的集线器上。
3. 使用另一根网线，将你的嗅探分析器也连接到集线器上。
4. 从你的集线器连接一根网线到交换机上，将集线器连接到网络上。

![](读书笔记：Wireshark数据包分析实战(第2版)/18.png)

现在你已经将目标设备和你的嗅探分析器连接到了同一个广播域中，所有从你的目标设备流入流出的网络流量都将在集线器中广播，从而让你的嗅探分析器可以捕获到这些数据包，如图2-6所示。

![](读书笔记：Wireshark数据包分析实战(第2版)/19.png)

在大多数情况下，集线器输出会将目标设备的全双工变成半双工。尽管这种方法并不是进行网络线路监听最彻底的方法，但在你的交换机不支持端口镜像时它可能是你唯一的选择。但是，请记住，你的集线器同样需要一个电源线连接，而某些情况下你却很难找到。

> 作为友情提示，在拔掉用户的设备时，你应该事先给用户一个善意的提醒，否则如果碰巧这位用户是公司CEO，你就惨了。

#### 找到真正的集线器

当进行集线器输出时，你需要确保你使用的设备是一个真正的集线器，而不是虚假标记的交换机。有几家网络硬件厂商有着营销的坏习惯，会把一些低级别的交换机当做集线器进行出售。如果你使用的并不是一个可信的经过测减的集线器，你将只会看到你自己的流量，而不是目标设备的流量。

当你找到一个集线器时，你需要对它进行测试，来确保它确实是一个集线器。如果是的话，它绝对值得你收藏！确定一个设备是否真的是集线器的最好方法，就是连上两台电脑，然后看这两台电脑是否能嗅探对方与网络其他设备之间的网络通信。如果能监听到的话，那它就是一款真正的集线器。

### 使用网络分流器

大家都知道这句谚语：“有牛排可以吃的时候，为什么要选择鸡肉呢？”这种选择，也适用于使用网络分流器与集线器输出的对比上。

网络分流器是一个硬件设备，你可以将它放置在网络布线系统的两个端点之间，来捕获这两个端点之间的数据包。与集线器输出类似，你可以在网络上放置一个硬件以捕获你需要的数据包。所不同的是，这次你并不是使用集线器，而是使用一个专门为了网络分析而设计的特殊硬件。

网络分流器又分为两种基本类型：聚合的和非聚合的。这两种分流器都安置在两个设备之间，来嗅探所有流经的网络通信。它们之间最基本的区别在于：非聚合的网络分流器有4个端口，如图2-7所示，而聚合分流器则只有3个端口。

![](读书笔记：Wireshark数据包分析实战(第2版)/20.png)

网络分流器通常还需要一个电源连接，但也有一些是带电池的，它们可以不需要插入一个电源插座就可以进行短暂的数据包嗅探。

* 聚合的网络分流器

  聚合的网络分流器的使用方法是最简单的。它只有一个物理的流量监听口，来对双向通信进行嗅探。

  为了使用聚合的网络分流器来捕获一台接入交换机的电脑流入流出的所有流量，你只需要按照如下步骤进行操作。

  1. 从交换机上拔下目标电脑的网线。

  2. 将连接目标电脑网线的另一端插入到网络分流器的“in”端口中。

  3. 将另一根网线的一端插入到网络分流器的“out”端口，并将另一端插入到网络交换机。

  4. 将最后一根网线的一端插入网络分流器的“monitor”端口，并将另一端插入到你作为嗅探器使用的电脑上。

聚合网络分流器的连接应该如图2-8所示的那样，一旦连好之后，你的嗅探器就能够捕获到你接入网络分流器的所有流入流出的网络流量。

![](读书笔记：Wireshark数据包分析实战(第2版)/21.png)

* 非聚合的网络分流器

  非聚合的网络分流器比起聚合的稍微复杂一些，但它在进行流量捕获时有着更好的灵活性。与聚合网络分流器仅仅只有一个监听端口来嗅探双向通信流量不同的是，非聚合的网络分流器有着两个监听端口。一个监听端口是用来要探流出方向的网络流量（从电脑到分流器端口的方向），另一个监听端口是用米嗅探流入方向的网络流量（从分流器端口到电脑的方向）。

  为了捕获一台连接交换机的电脑的所有流入流出网络流量，你则需要按照如下步骤进行配置。

  1. 从交换机上拔下电脑连接网线。

  2. 将电脑连接网线的另一端插入到网络分流器的“in”端口上。

  3. 将另一根网线的一端插入到网络分流器的“out”端口，然后将另一端捷入到网络交换机上。

  4. 将第三根网线插入到网络分流器的“MonitorA”端口，并将另一端插入到你作为嗅探器使用的电脑的一块网卡接口上。、

  5. 将最后一根网线插入到网络分流器的“MonitorB”端口，并将另一端入到你作为嗅探器使用的电脑的第二块网卡接口上。

     非聚合网络分流器的连接方式如图2-9所示。
     ·选择一款网络分流器

* 选择一款网络分流器

  网络分流器拥有两种不同的类型，那么哪一种会更好一些呢？在大多数况下，聚合的网络分流器是首选，因为它们需要较少的网线，同时在嗅探器电脑上也不需要两块网卡。然而，在一些你需要捕获高带宽的流量，或是只需要关注一个方向上的流量时，非聚合的网络分流器会更加适用。

  ![](读书笔记：Wireshark数据包分析实战(第2版)/22.png)

### ARP欺骗

进行网络线路监听最让人喜欢的技术，就是ARP欺骗。我们将在第6章中详细介绍ARP协议，但在这里会进行简要解释，以帮助了解这种技术是如何工作的。

* ARP查询过程

在第1章里，我们介绍了OS1参考模型中在第2层与第3层上数据包寻址的两种主要方式。这些第2层地址，或称为MAC地址，在无论你使用哪种第3层寻址方案时，都会与之协同工作。

在本书中，按照行业标准术语，我们将第3层寻址方案称为IP寻址系统。
网络上的所有设备相互通信时在第3层上均使用IP地址。由于交换机在OSI模型的第2层上工作，它们只认识第2层上的MAC地址，因此网络设备必须在它们创建的数据包中包含这些信息。当这些设备在不知道通信对方的MAC地址时，必须要通过已知的第3层IP地址来进行查询，这样才可能通过交换机将流量传输给相应的设备。

这些翻译过程就是通过第2层上的ARP协议来进行实施的。连接到以太网的计算机的ARP查询过程，是从一台计算机想要与另一台进行通信时开始的。发起通信的计算机首先检查自己的ARP缓存，查看它是否已经有对方IP地址对应的MAC地址。

如果不存在，它将往数据链路层广播地址FF:FF:FF:FF:FF发送一个ARP广播请求包。作为一个广播数据包，它会被这个特定的以太网广播域上的每台计算机接收，这个请求包问道：“某某IP地址的MAC地址是什么？

不匹配目标IP地址的计算机会简单地选择丢弃这个请求包。而目标计算机则选择答复这个数据包，通过ARP应答告知它的MAC地址。此时，发起通信的计算机就获取到了数据链路层的寻址信息，便可以利用它与远端计算机进行通信，同时将这些信息保存在ARP缓存中，来加速以后的网络访问。

* ARP欺骗是如何工作的

  ARP欺骗，有时也被称为ARP缓存中毒，是通过发送包含虚假MAC地址的ARP消息，以劫持其他计算机流量的过程。图2-10显示了ARP欺骗的具体过程。

  ARP欺骗是一种在交换式网络中进行监听的高级技术。它通常由攻击者用于向客户端系统发送虚假地址的数据包，以截获特定的网络流量或者对目标进行拒绝服务（DoS）攻击。然而，它也可以是一种在交换式网络中捕获目标系统数据包的合法方式。

![](读书笔记：Wireshark数据包分析实战(第2版)/23.png)

* 使用Cain  & Abel软件

  当试图进行ARP欺骗时，第一步你需要获得一些必要的工具来搜集相关信息。在我们的演示中，我们将使用一款流行的安全工具Cain  & Abel。

  在你使用Cain&Abel软件之前，你需要收集某些信息，包括嗅探分析器系统的IP地址，你所希望嗅探网络流量的远程计算机的IP地址，以及远程计算机所连接的上游路由器IP地址。

  当你第一次打开Cain&Abel软件后，你会发现在软件窗口的顶端有着一系列的标签页（ARP缓存中毒攻击只是强大的Cain&Abel软件其中一个功能）。
  为了演示我们的例子，我们将切换到“嗅探器”选项卡上。当你单击此选项卡，你应该会看到一个空表，如图2-11所示。

  ![](读书笔记：Wireshark数据包分析实战(第2版)/27.png)

  要完成此表，你需要激活这款软件的内置嗅探器，扫描你的网络并找出活跃主机。请按以下步骤进行操作以完成上述目标。

  1. 单击工具栏上左起第二个图标，类似网卡形状的那个。

  2. 你会被要求选择你希望进行嗅探的网络接口。这个接口应该连接到你所希望进行ARP欺骗的网络。选择这个网络接口，然后单击OK按钮（要确保按下这个按钮，以激活Cain&Abel软件内置的嗅探器）。

  3. 要建立在你的网络上可用主机的列表，单击加号（+）图标。MAC地址扫描器对话框将会出现，如图2-12所示。请选择“The All hosts in my subnet'
     圆形按钮（或者你可以选择特定的地址范围），单击OK继续。

     ![](读书笔记：Wireshark数据包分析实战(第2版)/28.png)

     现在表格中应该填满了你所在网络中的所有主机的信息，包括它们的MAC 地址、IP地址和供应商信息等。这是你开始进行ARP欺骗的目标主机列表。

     在程序窗口的底部，你应该会看到另一组选项卡，选择它们将带你到晚报器标题下的其他窗口。现在，你已经创建了主机列表，你就可以选择ARP选员卡，切换至ARP窗口中。

     在ARP窗口中，你会看到两个空的表格。当你完成下面的操作步骤之后上方的表格中将显示出你的ARP欺骗过程涉及的设备列表，而下方表格则会示出在你进行中毒攻击的计算机之间的所有通信内容。

     进行ARP欺骗攻击，请按照下列步骤进行操作。

     ①在屏幕上方的空白区域中单击，然后单击程序标准工具栏中的加号（+)图标

     ②出现的窗口中会有两个选择栏。在左侧，你可以看到网络上的所有活跃主机的列表。单击你希望进行网络流量嗅探的目标系统IP地址，右边的选择栏中将会显示出网络中除了你所选择的目标主机IP地址之外的所有主机列表。

     ③在右边的选择栏中，单击目标计算机的直接上游路由器（即网关）P地址，如图2-13所示，然后单击“OK”。这两个设备的IP地址现在应该会被显示在主程序窗口上方的表格中。

     ④完成这个过程的最后一步，单击标准工具栏中黄黑相间的辐射符号，这个操作将激活Cain&Abel软件的ARP欺骗功能。让你的嗅探分析器作为从目标系统到它的上游路由器之间所有通信的中间人。你现在应该就能启动你的数据包嗅探器，并开始分析过程。当你完成流量捕获之后，只需再次单击黄黑相间的辐射图标，便可以停止ARP欺骗过程。

     ![](读书笔记：Wireshark数据包分析实战(第2版)/29.png)

* 关于ARP欺骗的警示

  作为ARP欺骗过程的最后警示，你必须要非常清楚实施这个过程中每个系统的角色与作用。在目标设备拥有很高的网络使用流量时，例如一台有着1Gbits联网线路的文件服务器，不要使用这项技术（尤其是当你的嗅探分析系统只提供了一条100Mbit/s的链路时）。

  当你使用在这个例子中演示的这项技术对网络流量进行重路由时，所有目标系统发送和接收的流量都必须先通过你的嗅探分析系统，因此，你的呗探分析系统可能成为整个通信过程中的瓶颈。这种流量重路由会对你进行分析的系统造成一种拒绝服务攻击式的影响，将导致网络性能下降以及分析数据不完全。

  > 你可以使用一个称为非对称路由的功能，来避免所有的网络流量经过你的唤探分析器，所谓非对称路由。对于这种技术的更多信息，请参阅oxid.it用户手册（http:/www.oxid.it/ca um/topics/apr.htm）

## 在路由网络环境中进行嗅探

所有在交换式网络中用来监听网络线路的技术在路由网络环境中都同样适用。面对路由网络环境时，唯一需要重点考虑的问题是：当你调试一个涉及多个网络分段的故障时，如何安置你的嗅探器？正如你所学到的，一个设备的广播域一直延伸，直到到达一个路由器，在这个点上，网络流量将会被转发给上游路由器。

在网络数据必须经过多个路由器的情况下，在各个路由器上分析网络流量是非常重要的。举例来说，考虑你很可能会遇到的一个场景，在网络中由几个路由器将几个网络分段连接在一起。在这个网络中，每个网段与上游网段进行通信，来获取和存储数据。

如图2-14所示，我们要解决的一个故障是：一个下游子网D，无法与网络A中的任何设备进行通信。

如果你在存在故障的网络D中嗅探流量，你可以清楚地看到数据包被传输到了其他网段，但你可能看不到回来的数据包所说的“一会回来”。如果你重费考虑你嗅探器的部署位置，在网络D的直接上游网段（网络B）中开始嗅探，你将会有一个关于故障更清晰的视图。

在这个位置上，你可能会发现，来自网络D的流量被丢弃了，或是被网络B的路由器错误地路由了。

![](读书笔记：Wireshark数据包分析实战(第2版)/24.png)

最终，这会让你了解到这是一个路由器配置问题，在纠正之后，便会解决掉你的大麻烦。虽然这个场景有点宽泛，但其中的精髓是，在处理涉及多个网段与路由器的问题时，你可能需要将你的嗅探器移动到不同的位置上，才能获得一个完整的网络画面。

这是一个基本的例子，说明了为什么往往需要在不同的网段中对多个设备流量进行嗅探，才能很快地诊断出故障的根本原因。

## 部署嗅探器的实践指南

我们已经介绍了在交换式网络中捕获网络流量的4种不同方法。我们可以再增加一种方式，适用于我们仅仅在单个系统上安装嗅探器软件并监听这台系统进出的流量。在某个特定场景中，你可能不太容易确定应该用上述这5种方法中的哪种才是最合适的。表2-2提供了每种部署方法的通用准则。

![](读书笔记：Wireshark数据包分析实战(第2版)/25.png)

作为分析师，我们需要尽可能地隐蔽。最理想的境界是，我们采集我们所需要的数据，而不留下任何的痕迹。这就像是法医在调查时不想对犯罪现场造成任何破坏一样。我们也不希望破坏我们所捕获的网络流量。

当在后面章节中逐步面对一些实际场景时，我们将会逐个对案例进行详细分析，来讨论捕获数据最好的方式。目前来说，图2-15中给出的流程图应该能够帮助你决定用来捕获流量的最佳方法。请记住，这个流程图只是一个简单的通用参考，并不涵盖所有用来监听网络线路的可能方法。

![](读书笔记：Wireshark数据包分析实战(第2版)/26.png)

# 第3章：Wireshark入门

## Wireshark简史

Wireshark的历史相当久远，其最初的版本叫做Ethereal，由毕业于密苏里大学堪萨斯城分校计算机科学专业的Gerald Combs出于项目需要而开发，并于1998年以GNU Public Licence（GPL）开源许可证发布。

在发布了Ethereal8年之后，Combs辞职另谋高就，但是在那个时候他的雇主公司掌握着Ethereal的商标权，而Combs也没能和其雇主就取得Ethcreal商标达成协议。于是Combs和整个开发团队在2006年中的时候将这个项目重新命名为Wireshark。

Wireshark随后迅速地取得了大众的青睐，而其合作开发团队也壮大到500人以上，然而之前的Ethereal项目却再没有前进过一步。

## Wireshark的优点

Wiredhark在日常应用中具有许多优点，无论你是初学者还是数据包分析专家，Wireshak都能通过丰富的功能来满足你的需要。在第1章中，我们为挑选数据包嗅探工具提出过一些重要的判断特征，让我们来检查一下Wireshak是否具有这些特征。

支持的协议：Wirestak在支持协议的数量方面是出类拔萃的—于本书藏稿时Wreshark 已提供了超过850种协议的支持。这些协议包括从最基础的IP协议和DHCP 协议到高级的专用协议比如AppleTalk 和BitTorrent等。由于Wireshark在开源模式下进行开发，每次更新都会增加一些对新协议的支持。

> 在一些特殊情况下，如果Wireshark并不支持你所需要的协议，你还可以通过自己编写代码提供相应的支持，并提供给Wirshark的开发者，以便于使之能被包含在之后版本中（当然是在代码被采纳的情况下）。

**用户友好度:**Wircslark的界面是数据包嗅探工具中最容易理解的工具之。它基于6GU1，并提供了清晰的菜单栏和简明的布局。为了增强实用性，它还提供了不同协议的彩色高亮，以及通过图形展示原始数据细节等不同功能。
cpaump使用复杂命令行的那些数据包嗅探工具相比，Wak的图形化界面对于那些数据包分析的初学者而言，是十分方便的。

**价格：**由于Wircshak是开源的，它在价格上面是无以匹敌的。Wresme是递希GPL协议发布的自由软件，任何人无论出于私人还是商业目的，都可以下载并且使用Wireshark。

**程序支持:**一个软件的成败通常取决于其程序支持的好坏。虽然像Wireshark这样的自由分发软件很少会有正式的程序支持，而是依赖于开源社区的用户群，但是幸运的是，Wireshark社区是最活跃的开源项目社区之一。Wireshark网页上给出了许多种程序支持的相关链接，包括在线文档、支持与开发wiki、FAQ，并可以注册 Wireshark 开发者都关注的邮件列表。CACE Technologies通过SharkNet项目也对外提供付费支持。

**支持的操作系统：**Wireshark对主流的操作系统都提供了支持，其中包括Windows、Mac OSX以及基于Linux的系统。你可以在Wireshark的主页上查询所有Wireshark支持的操作系统列表。

## 安装Wireshark

略

## Wireshark初步入门

当你成功地在你的系统中装好了Wireshark，你就可以开始熟悉它了。当你终于打开了这个功能强大的数据包嗅探器，却会发现你什么都看不见！

好吧，Wireshark在刚打开的时候确实不太好玩，只有在拿到一些数据之后事情才会变得有趣起来。

### 第一次捕获数据包

为了能让Wireshark得到一些数据包，你可以开始你的第一次数据包捕获实验了。你可能会想：“当网络什么问题也没有的时候，怎么能捕获数据包呢？”

首先，网络总是有问题的。如果你不相信，那么你去给你网络上所有的用户发一封邮件，告诉他们一切都工作得非常好。

第二，做数据包分析并不一定要等到有问题的时候再做。事实上，大多数的数据包分析员在分析没有问题的网络流量上花的时间要比解决问题的时候多。为了能高效地解决网络问题，你也同样需要得到一个基准来与之对比。举高来说，如果你想通过分析网络流量来解决关于DHCP的问题，你至少需要如道DHCP在正常工作时的数据流是什么样子的。

更广泛地讲，为了能够发现日常网络活动的异常，你必须对日常网络活动的情况有所掌握。当你的网络正常运行时，你以此作为基准，就能知道网络流量在正常情况下的样子。

闲言少叙，让我们来捕获一些数据包吧！

1. 打开Wireshark。

2. 从主下拉菜单中选择Capture，然后是Interface。

   这时你应该可以看到一个对话框，里面列出了你可以用来捕获数据包的各种设备，以及它们的IP地址。

3. 选择你想要使用的设备，如图3-4所示，然后单击Start，或者直接单击欢迎面面中Interface List下的某一个设备。随后数据就会在窗口中呈现出来。

   ![](读书笔记：Wireshark数据包分析实战(第2版)/30.png)

4. 等上一分钟左右，当你打算停止捕获并查看你的数据时，在Caqurc的下拉菜单中单击Stop按组即可。

      当你做完了以上步骤并完成了数据包的捕获，Wireshak的主窗口中应该已经呈现了相应的数据，但此时你可能已经对那些数据的规模感到头疼，这也就是为什么我们把Wireshark一整块的主窗口进行拆分的原因。

# 视频笔记

## 课程介绍

Wireshark是目前全球使用最广泛的开源抓包软件（前身为Ethereal），是一个通用化的网络数据嗅探器和协议分析器，由Gerald Combs编写并于1998年以GPL开源许可证发布。如果是网络工程师，可以通过Wireshark对网络进行故障定位和排错；如果是安全工程师，可以通过Wireshark对网络黑渗透攻击进行快速定位并找出攻击源；如果是测试或者软件工程师，可以通过wreshark分析底层通信机制等等。